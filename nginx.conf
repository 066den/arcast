events {
    worker_connections 1024;
}

http {
    upstream app {
        server app:3000;
    }

    # Глобальные лимиты
    client_max_body_size 2500m;

    ############################################################
    # HTTP (80): localhost для локальной разработки (без редиректа)
    ############################################################
    server {
        listen 80;
        server_name localhost 127.0.0.1;

        # MinIO через localhost (для локальной разработки без SSL)
        location /arcast-s3/ {
            # Проксируем напрямую на MinIO с bucket name в пути
            # MinIO использует path-style: /bucket-name/object-key
            proxy_pass http://minio:9000/arcast-s3/;

            # большие аплоады / form POST — не буферизуем тело
            proxy_request_buffering off;
            proxy_buffering         off;

            proxy_http_version 1.1;
            proxy_set_header Connection "";

            # заголовки / схема
            proxy_set_header Host              minio:9000;           # важно для подписи/пресайнов
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto http;

            # поддержка Range (медиа)
            proxy_set_header Range    $http_range;
            proxy_set_header If-Range $http_if_range;

            # Явно пробросим тип/длину — не обязательно, но безопасно
            proxy_set_header Content-Type   $content_type;
            proxy_set_header Content-Length $content_length;

            proxy_read_timeout 600s;
            proxy_send_timeout 600s;

            # CORS заголовки для всех запросов (включая GET)
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "*" always;
            add_header Access-Control-Max-Age 86400 always;

            # CORS preflight (если идёт прямой браузерный POST)
            if ($request_method = OPTIONS) {
                return 204;
            }
        }

        # Проксируем напрямую на приложение (без редиректа на HTTPS)
        location / {
            proxy_pass http://app;
            proxy_http_version 1.1;
            
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;

            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_cache_bypass $http_upgrade;
        }

        # Health-check
        location = /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }

    ############################################################
    # HTTP (80): домены arcast.studio -> редирект на HTTPS
    ############################################################
    server {
        listen 80 default_server;
        server_name arcast.studio www.arcast.studio;

        # ACME challenge (certbot webroot)
        location ^~ /.well-known/acme-challenge/ {
            alias /var/www/certbot/.well-known/acme-challenge/;
            default_type "text/plain";
            try_files $uri =404;
        }

        # Health-check без редиректа (удобно для балансировщиков)
        location = /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # Всё остальное — принудительно на HTTPS
        location / {
            return 301 https://$host$request_uri;
        }
    }

    ###############################################
    # HTTPS (443): только сертификаты Let's Encrypt
    ###############################################
    server {
        listen 443 ssl default_server;
        http2 on;
        server_name arcast.studio www.arcast.studio localhost 127.0.0.1;

        # Пути к сертификатам (Let's Encrypt или fallback self-signed)
        # Entrypoint скрипт создает fallback в /etc/nginx/certs/ если Let's Encrypt недоступен
        ssl_certificate     /etc/nginx/certs/server.crt;
        ssl_certificate_key /etc/nginx/certs/server.key;

        # (Опционально, если используешь ssl-stapling)
        # Используем chain.pem если есть (только для Let's Encrypt)
        # ssl_trusted_certificate /etc/letsencrypt/live/arcast.studio/chain.pem;

        ssl_session_cache   shared:SSL:10m;
        ssl_session_timeout 10m;
        ssl_protocols       TLSv1.2 TLSv1.3;
        ssl_ciphers         HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        # Рекомендуется (если есть DNS и системный resolver)
        resolver 1.1.1.1 1.0.0.1 valid=300s ipv6=off;
        resolver_timeout 5s;

        # OCSP stapling (только для Let's Encrypt, отключено для self-signed)
        # ssl_stapling on;
        # ssl_stapling_verify on;

        # MinIO через /arcast-s3/ на порту 443 (для production)
        location /arcast-s3/ {
            # Проксируем напрямую на MinIO с bucket name в пути
            # MinIO использует path-style: /bucket-name/object-key
            proxy_pass http://minio:9000/arcast-s3/;

            # большие аплоады / form POST — не буферизуем тело
            proxy_request_buffering off;
            proxy_buffering         off;

            proxy_http_version 1.1;
            proxy_set_header Connection "";

            # заголовки / схема
            proxy_set_header Host              minio:9000;           # важно для подписи/пресайнов
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;

            # поддержка Range (медиа)
            proxy_set_header Range    $http_range;
            proxy_set_header If-Range $http_if_range;

            # Явно пробросим тип/длину — не обязательно, но безопасно
            proxy_set_header Content-Type   $content_type;
            proxy_set_header Content-Length $content_length;

            proxy_read_timeout 600s;
            proxy_send_timeout 600s;

            # CORS заголовки для всех запросов (включая GET)
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "*" always;
            add_header Access-Control-Max-Age 86400 always;

            # CORS preflight (если идёт прямой браузерный POST)
            if ($request_method = OPTIONS) {
                return 204;
            }
        }

        # Прокси до приложения
        location / {
            proxy_pass http://app;
            proxy_http_version 1.1;
            
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;

            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_cache_bypass $http_upgrade;
        }

        # Health-check по HTTPS
        location = /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }

    ############################################################
    # HTTP (80): s3.arcast.studio для локальной разработки (без SSL)
    ############################################################
    server {
        listen 80;
        server_name s3.arcast.studio;

        # крупные аплоады и большие заголовки (policy может быть пухлой)
        client_max_body_size        2500m;
        client_body_buffer_size     16m;
        client_header_buffer_size   16k;
        large_client_header_buffers 4 32k;

        location / {
            proxy_pass http://minio:9000;

            # большие аплоады / form POST — не буферизуем тело
            proxy_request_buffering off;
            proxy_buffering         off;

            proxy_http_version 1.1;
            proxy_set_header Connection "";

            # заголовки / схема
            proxy_set_header Host              $host;           # важно для подписи/пресайнов
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto http;

            # поддержка Range (медиа)
            proxy_set_header Range    $http_range;
            proxy_set_header If-Range $http_if_range;

            # Явно пробросим тип/длину — не обязательно, но безопасно
            proxy_set_header Content-Type   $content_type;
            proxy_set_header Content-Length $content_length;

            proxy_read_timeout 600s;
            proxy_send_timeout 600s;

            # CORS preflight (если идёт прямой браузерный POST)
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin "*" always;
                add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
                add_header Access-Control-Allow-Headers "*" always;
                add_header Access-Control-Max-Age 86400 always;
                return 204;
            }
        }

        location = /health { return 200 "ok\n"; add_header Content-Type text/plain; }
    }

    ############################################################
    # HTTPS (443): s3.arcast.studio для production
    ############################################################
    server {
        listen 443 ssl;
        http2 on;
        server_name s3.arcast.studio;

        # Пути к сертификатам (Let's Encrypt или fallback self-signed)
        ssl_certificate     /etc/nginx/certs/server.crt;
        ssl_certificate_key /etc/nginx/certs/server.key;
        ssl_session_cache   shared:SSL:10m;
        ssl_session_timeout 10m;
        ssl_protocols       TLSv1.2 TLSv1.3;
        ssl_ciphers         HIGH:!aNULL:!MD5;

        # крупные аплоады и большие заголовки (policy может быть пухлой)
        client_max_body_size        2500m;
        client_body_buffer_size     16m;
        client_header_buffer_size   16k;
        large_client_header_buffers 4 32k;

        location / {
            proxy_pass http://minio:9000;

            # большие аплоады / form POST — не буферизуем тело
            proxy_request_buffering off;
            proxy_buffering         off;

            proxy_http_version 1.1;
            proxy_set_header Connection "";

            # заголовки / схема
            proxy_set_header Host              $host;           # важно для подписи/пресайнов
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;

            # поддержка Range (медиа)
            proxy_set_header Range    $http_range;
            proxy_set_header If-Range $http_if_range;

            # Явно пробросим тип/длину — не обязательно, но безопасно
            proxy_set_header Content-Type   $content_type;
            proxy_set_header Content-Length $content_length;

            proxy_read_timeout 600s;
            proxy_send_timeout 600s;

            # CORS preflight (если идёт прямой браузерный POST)
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin "*" always;
                add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
                add_header Access-Control-Allow-Headers "*" always;
                add_header Access-Control-Max-Age 86400 always;
                return 204;
            }
        }

        location = /health { return 200 "ok\n"; add_header Content-Type text/plain; }
    }

    ############################################################
    # HTTPS (9000): arcast.studio:9000 для MinIO (production)
    ############################################################
    server {
        listen 9000 ssl;
        server_name arcast.studio www.arcast.studio;

        # Пути к сертификатам (Let's Encrypt или fallback self-signed)
        ssl_certificate     /etc/nginx/certs/server.crt;
        ssl_certificate_key /etc/nginx/certs/server.key;
        ssl_session_cache   shared:SSL:10m;
        ssl_session_timeout 10m;
        ssl_protocols       TLSv1.2 TLSv1.3;
        ssl_ciphers         HIGH:!aNULL:!MD5;

        # крупные аплоады и большие заголовки (policy может быть пухлой)
        client_max_body_size        2500m;
        client_body_buffer_size     16m;
        client_header_buffer_size   16k;
        large_client_header_buffers 4 32k;

        # MinIO через /arcast-s3/ на порту 9000
        location /arcast-s3/ {
            # Проксируем напрямую на MinIO с bucket name в пути
            # MinIO использует path-style: /bucket-name/object-key
            proxy_pass http://minio:9000/arcast-s3/;

            # большие аплоады / form POST — не буферизуем тело
            proxy_request_buffering off;
            proxy_buffering         off;

            proxy_http_version 1.1;
            proxy_set_header Connection "";

            # заголовки / схема
            proxy_set_header Host              minio:9000;           # важно для подписи/пресайнов
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;

            # поддержка Range (медиа)
            proxy_set_header Range    $http_range;
            proxy_set_header If-Range $http_if_range;

            # Явно пробросим тип/длину — не обязательно, но безопасно
            proxy_set_header Content-Type   $content_type;
            proxy_set_header Content-Length $content_length;

            proxy_read_timeout 600s;
            proxy_send_timeout 600s;

            # CORS заголовки для всех запросов (включая GET)
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "*" always;
            add_header Access-Control-Max-Age 86400 always;

            # CORS preflight (если идёт прямой браузерный POST)
            if ($request_method = OPTIONS) {
                return 204;
            }
        }

        location = /health { return 200 "ok\n"; add_header Content-Type text/plain; }
    }
}

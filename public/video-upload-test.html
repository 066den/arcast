<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video Upload Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .container {
        max-width: 600px;
        margin: 0 auto;
      }
      .upload-area {
        border: 2px dashed #ccc;
        padding: 20px;
        text-align: center;
        margin: 20px 0;
      }
      .upload-area.dragover {
        border-color: #007bff;
        background-color: #f8f9fa;
      }
      .progress {
        width: 100%;
        height: 20px;
        background-color: #f0f0f0;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
      }
      .progress-bar {
        height: 100%;
        background-color: #007bff;
        width: 0%;
        transition: width 0.3s;
      }
      .log {
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
        font-family: monospace;
        font-size: 12px;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        cursor: pointer;
      }
      .success {
        color: green;
      }
      .error {
        color: red;
      }
      .info {
        color: blue;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Video Upload Test</h1>

      <div class="upload-area" id="uploadArea">
        <p>Drop video file here or click to select</p>
        <input
          type="file"
          id="fileInput"
          accept="video/*"
          style="display: none"
        />
      </div>

      <div class="progress" id="progressContainer" style="display: none">
        <div class="progress-bar" id="progressBar"></div>
      </div>

      <div>
        <button id="uploadBtn" disabled>Upload Video</button>
        <button id="clearBtn">Clear</button>
      </div>

      <div class="log" id="log"></div>
    </div>

    <script>
      const uploadArea = document.getElementById('uploadArea')
      const fileInput = document.getElementById('fileInput')
      const uploadBtn = document.getElementById('uploadBtn')
      const clearBtn = document.getElementById('clearBtn')
      const progressContainer = document.getElementById('progressContainer')
      const progressBar = document.getElementById('progressBar')
      const log = document.getElementById('log')

      let selectedFile = null

      function logMessage(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString()
        const logEntry = document.createElement('div')
        logEntry.className = type
        logEntry.textContent = `[${timestamp}] ${message}`
        log.appendChild(logEntry)
        log.scrollTop = log.scrollHeight
      }

      function updateProgress(percent) {
        progressBar.style.width = percent + '%'
        progressBar.textContent = percent + '%'
      }

      function showProgress() {
        progressContainer.style.display = 'block'
      }

      function hideProgress() {
        progressContainer.style.display = 'none'
        updateProgress(0)
      }

      // File selection
      uploadArea.addEventListener('click', () => fileInput.click())
      uploadArea.addEventListener('dragover', e => {
        e.preventDefault()
        uploadArea.classList.add('dragover')
      })
      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover')
      })
      uploadArea.addEventListener('drop', e => {
        e.preventDefault()
        uploadArea.classList.remove('dragover')
        const files = e.dataTransfer.files
        if (files.length > 0) {
          handleFileSelect(files[0])
        }
      })

      fileInput.addEventListener('change', e => {
        if (e.target.files.length > 0) {
          handleFileSelect(e.target.files[0])
        }
      })

      function handleFileSelect(file) {
        selectedFile = file
        uploadArea.innerHTML = `
                <p><strong>Selected:</strong> ${file.name}</p>
                <p><strong>Size:</strong> ${(file.size / (1024 * 1024)).toFixed(2)} MB</p>
                <p><strong>Type:</strong> ${file.type}</p>
            `
        uploadBtn.disabled = false
        logMessage(
          `File selected: ${file.name} (${(file.size / (1024 * 1024)).toFixed(2)} MB)`,
          'info'
        )
      }

      // Upload function
      uploadBtn.addEventListener('click', async () => {
        if (!selectedFile) return

        try {
          uploadBtn.disabled = true
          showProgress()
          logMessage('Starting upload process...', 'info')

          // Step 1: Get presigned POST data
          logMessage('Step 1: Getting presigned POST data...', 'info')

          const formData = new FormData()
          formData.append('videoFile', selectedFile)
          formData.append('folder', 'samples')
          formData.append('usePresignedPost', 'true')

          const response = await fetch('/api/upload/video', {
            method: 'POST',
            body: formData,
          })

          logMessage(
            `API Response Status: ${response.status}`,
            response.ok ? 'success' : 'error'
          )

          if (!response.ok) {
            const errorText = await response.text()
            logMessage(`API Error: ${errorText}`, 'error')
            return
          }

          const data = await response.json()
          logMessage('Presigned POST data received!', 'success')
          logMessage(`Upload Method: ${data.uploadMethod}`, 'info')
          logMessage(`File Key: ${data.presignedPost?.fileKey}`, 'info')
          logMessage(`CDN URL: ${data.presignedPost?.cdnUrl}`, 'info')

          // Step 2: Upload directly to S3
          logMessage('Step 2: Uploading directly to S3...', 'info')

          const uploadFormData = new FormData()

          // Add all presigned fields
          Object.entries(data.presignedPost.fields).forEach(([key, value]) => {
            uploadFormData.append(key, value)
            logMessage(`Added field: ${key}`, 'info')
          })

          // Add file last
          uploadFormData.append('file', selectedFile)

          updateProgress(50)

          const uploadResponse = await fetch(data.presignedPost.url, {
            method: 'POST',
            body: uploadFormData,
          })

          logMessage(
            `S3 Upload Status: ${uploadResponse.status}`,
            uploadResponse.ok ? 'success' : 'error'
          )

          if (uploadResponse.ok) {
            updateProgress(100)
            logMessage('Upload successful!', 'success')
            logMessage(`Final CDN URL: ${data.presignedPost.cdnUrl}`, 'success')

            // Step 3: Verify file availability
            logMessage('Step 3: Verifying file availability...', 'info')

            const checkResponse = await fetch(data.presignedPost.cdnUrl, {
              method: 'HEAD',
            })

            logMessage(
              `File Check Status: ${checkResponse.status}`,
              checkResponse.ok ? 'success' : 'error'
            )

            if (checkResponse.ok) {
              logMessage('File is accessible!', 'success')
            } else {
              logMessage('File is not accessible', 'error')
            }
          } else {
            const errorText = await uploadResponse.text()
            logMessage(`S3 Upload Error: ${errorText}`, 'error')
          }
        } catch (error) {
          logMessage(`Upload Error: ${error.message}`, 'error')
        } finally {
          uploadBtn.disabled = false
          setTimeout(() => hideProgress(), 2000)
        }
      })

      // Clear function
      clearBtn.addEventListener('click', () => {
        selectedFile = null
        uploadArea.innerHTML = '<p>Drop video file here or click to select</p>'
        uploadBtn.disabled = true
        hideProgress()
        log.innerHTML = ''
        fileInput.value = ''
      })

      logMessage('Video upload test page loaded', 'info')
    </script>
  </body>
</html>

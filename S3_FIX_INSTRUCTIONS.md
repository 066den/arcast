# Инструкция по исправлению проблемы с загрузкой файлов на S3

## Проблемы, которые были исправлены:

### 1. Небезопасные захардкоженные credentials

**Проблема:** В `src/lib/s3.ts` использовались захардкоженные API ключи вместо переменных окружения.

**Исправление:** Теперь используются переменные окружения:

- `AWS_REGION`
- `AWS_ENDPOINT`
- `AWS_ACCESS_KEY_ID`
- `AWS_SECRET_ACCESS_KEY`
- `AWS_S3_BUCKET_NAME`

### 2. Неправильная конфигурация Next.js

**Проблема:** В `src/app/api/upload/video/route.ts` использовался устаревший формат конфигурации для App Router.

**Исправление:** Заменено на правильные экспорты:

```typescript
export const runtime = 'nodejs'
export const maxDuration = 300 // 5 минут для больших видео
```

### 3. Улучшенное логирование и обработка ошибок

Добавлено детальное логирование для отладки проблем с S3.

## Что нужно сделать:

### 1. Создать файл `.env.local`

Создайте файл `.env.local` в корне проекта со следующим содержимым:

```env
# AWS S3 / DigitalOcean Spaces Configuration
AWS_REGION=blr1
AWS_ENDPOINT=https://blr1.digitaloceanspaces.com
AWS_ACCESS_KEY_ID=ваш-access-key-id
AWS_SECRET_ACCESS_KEY=ваш-secret-access-key
AWS_S3_BUCKET_NAME=arcast-s3
```

### 2. Получить учетные данные DigitalOcean Spaces

1. Войдите в панель управления DigitalOcean
2. Перейдите в раздел "Spaces"
3. Создайте новый Space с именем `arcast-s3` (если еще не создан)
4. Перейдите в раздел "API" → "Spaces Keys"
5. Создайте новый ключ или используйте существующий
6. Скопируйте Access Key и Secret Key

### 3. Проверить конфигурацию

Запустите скрипт проверки:

```bash
node scripts/test-s3-config-ru.js
```

### 4. Настроить CORS для DigitalOcean Spaces

В панели управления DigitalOcean Spaces:

1. Перейдите в ваш Space
2. Откройте вкладку "Settings"
3. В разделе "CORS" добавьте правило:
   - Allowed Origins: `*` (или ваш домен)
   - Allowed Methods: `GET, PUT, POST, DELETE, HEAD`
   - Allowed Headers: `*`
   - Max Age: `3600`

## Возможные причины ошибки 400:

1. **Отсутствуют переменные окружения** - проверьте файл `.env.local`
2. **Неверные учетные данные** - проверьте Access Key и Secret Key
3. **Bucket не существует** - создайте Space с именем `arcast-s3`
4. **Неправильные права доступа** - убедитесь, что API ключ имеет права на запись
5. **Проблемы с CORS** - настройте CORS правила в DigitalOcean Spaces
6. **Превышен размер файла** - проверьте лимиты в `src/lib/constants.ts`

## Отладка:

После внесения изменений проверьте логи сервера. Теперь они содержат детальную информацию о процессе загрузки:

- Начало процесса загрузки
- Информация о файле (размер, тип)
- Детали подключения к S3
- Результат загрузки
- Детальные ошибки с указанием причины

Если проблема сохраняется, проверьте логи сервера для получения более точной информации об ошибке.
